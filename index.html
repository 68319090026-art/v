<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature IoT System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0; font-family: 'Tahoma', sans-serif;
            color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 0.8s ease;
            min-height: 100vh;
        }
        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏ó‡∏∞‡πÄ‡∏• (ON) / ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (OFF) */
        .bg-on { background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e'); }
        .bg-off { background-image: url('https://images.unsplash.com/photo-1472552944129-a03ccbd80499'); }

        .card {
            background: rgba(0, 0, 0, 0.75);
            max-width: 450px; margin: 30px auto;
            padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .temp-display { font-size: 56px; font-weight: bold; margin: 10px 0; text-shadow: 2px 2px 4px #000; }
        
        /* === ‡∏´‡∏•‡∏≠‡∏î‡∏õ‡∏£‡∏≠‡∏ó === */
        .tube-container {
            width: 40px; height: 200px;
            background: #222; margin: 20px auto;
            border-radius: 20px; border: 4px solid #555;
            position: relative; overflow: hidden;
        }
        .tube-fill {
            width: 100%; height: 0%;
            position: absolute; bottom: 0; left: 0;
            transition: height 0.5s, background 0.5s;
        }
        /* Animation ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏• */
        .tube-fill::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            animation: flow 1.5s infinite linear;
        }
        @keyframes flow { from {transform: translateY(100%);} to {transform: translateY(-100%);} }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
        button {
            padding: 12px 30px; font-size: 16px; border: none; border-radius: 50px;
            cursor: pointer; margin: 10px; transition: transform 0.1s; color: white;
        }
        button:active { transform: scale(0.95); }
        .btn-on { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-off { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        table { width: 100%; font-size: 14px; margin-top: 15px; border-collapse: collapse; }
        th, td { padding: 8px; border-bottom: 1px solid #444; }
        th { color: #aaa; }
    </style>
</head>
<body class="bg-off">

    <div class="card">
        <h2>üå° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ IoT</h2>
        <div style="color: #ccc;">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
        <div id="status" style="margin-top:5px; font-weight:bold; color:orange;">Connecting...</div>

        <div class="tube-container">
            <div id="tubeFill" class="tube-fill"></div>
        </div>

        <div class="temp-display" id="tempText">-- ¬∞C</div>

        <div style="background: rgba(255,255,255,0.1); border-radius:10px; padding:10px;">
            <canvas id="myChart" height="150"></canvas>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn-on" onclick="setSystem(true)">üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn-off" onclick="setSystem(false)">üî¥ ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <h3>üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
        <table id="logTable">
            <thead><tr><th>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</th></tr></thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>

    <script>
        // üëá ‡πÅ‡∏Å‡πâ URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ https:// ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /)
        const DB_URL = "https://viewvi-3e5ef-default-rtdb.firebaseio.com/";

        let chart;
        let lastTime = "";

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ 
                    label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)', data: [], 
                    borderColor: '#00d2ff', backgroundColor: 'rgba(0, 210, 255, 0.2)',
                    fill: true, tension: 0.4 
                }]},
                options: {
                    scales: { y: { beginAtZero: true, suggestedMax: 50 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function fetchData() {
            try {
                let res = await fetch(DB_URL + ".json");
                let data = await res.json();
                
                if(data) {
                    updateUI(data);
                }
            } catch(e) { console.log("Error:", e); }
        }

        function updateUI(data) {
            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            const statusEl = document.getElementById("status");
            if (data.systemOn) {
                document.body.className = "bg-on";
                statusEl.innerText = "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥";
                statusEl.style.color = "#2ecc71";
            } else {
                document.body.className = "bg-off";
                statusEl.innerText = "üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
                statusEl.style.color = "#e74c3c";
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
                return; 
            }

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            let temp = data.temperature || 0;
            document.getElementById("tempText").innerText = temp.toFixed(1) + " ¬∞C";

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏≠‡∏î‡∏õ‡∏£‡∏≠‡∏ó
            let fill = document.getElementById("tubeFill");
            let height = Math.min((temp / 50) * 100, 100); // Max 50c = 100%
            fill.style.height = height + "%";

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô
            if(temp < 30) fill.style.background = "linear-gradient(to top, #2ecc71, #27ae60)";
            else if(temp < 35) fill.style.background = "linear-gradient(to top, #f39c12, #e67e22)";
            else fill.style.background = "linear-gradient(to top, #e74c3c, #c0392b)";

            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞ Log (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
            let timeStr = data.timeString || "-";
            if (timeStr !== lastTime && timeStr !== "-") {
                lastTime = timeStr;
                
                // ‡∏•‡∏á‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤ HH:MM:SS)
                let timeOnly = timeStr.split(" ")[1];
                if(chart.data.labels.length > 10) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                chart.data.labels.push(timeOnly);
                chart.data.datasets[0].data.push(temp);
                chart.update();

                // ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Log
                let logBody = document.getElementById("logBody");
                let row = `<tr><td>${timeStr}</td><td>${temp.toFixed(1)} ¬∞C</td></tr>`;
                logBody.insertAdjacentHTML('afterbegin', row);
                if(logBody.children.length > 10) logBody.lastChild.remove();
            }
        }

        // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö
        async function setSystem(isOn) {
            await fetch(DB_URL + "systemOn.json", {
                method: "PUT", body: JSON.stringify(isOn)
            });
            fetchData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }

        initChart();
        setInterval(fetchData, 2000); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        fetchData();
    </script>
</body>
</html>
