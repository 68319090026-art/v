<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature IoT Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0; font-family: 'Tahoma', sans-serif;
            color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 0.5s ease;
            min-height: 100vh;
        }
        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .bg-on { background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e'); } /* ‡∏ó‡∏∞‡πÄ‡∏• */
        .bg-off { background-image: url('https://images.unsplash.com/photo-1472552944129-a03ccbd80499'); } /* ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô */

        .card {
            background: rgba(0, 0, 0, 0.8);
            max-width: 500px; margin: 20px auto;
            padding: 20px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        
        .temp-display { font-size: 60px; font-weight: bold; margin: 10px 0; text-shadow: 2px 2px 4px black;}
        
        /* ‡∏´‡∏•‡∏≠‡∏î‡∏õ‡∏£‡∏≠‡∏ó */
        .tube-container {
            width: 50px; height: 200px; background: #222; margin: 10px auto;
            border-radius: 25px; border: 3px solid #555; position: relative; overflow: hidden;
        }
        .tube-fill {
            width: 100%; height: 0%; position: absolute; bottom: 0; left: 0;
            transition: height 0.5s, background 0.5s;
        }

        /* ‡∏õ‡∏∏‡πà‡∏° */
        button {
            padding: 10px 25px; font-size: 16px; border: none; border-radius: 50px;
            cursor: pointer; margin: 5px; color: white;
        }
        .btn-on { background: #2ecc71; }
        .btn-off { background: #e74c3c; }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px;}
        th, td { padding: 8px; border-bottom: 1px solid #444; }
        th { color: #aaa; }
    </style>
</head>
<body class="bg-off">

    <div class="card">
        <h2>üå° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ IoT</h2>
        <div style="color:#ccc">üìç ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
        <div id="status" style="font-weight:bold; color:orange; margin-top:10px;">Connecting...</div>

        <div class="tube-container">
            <div id="tubeFill" class="tube-fill"></div>
        </div>

        <div class="temp-display" id="tempText">-- ¬∞C</div>

        <div style="background: rgba(255,255,255,0.1); padding:10px; border-radius:10px;">
            <canvas id="myChart" height="150"></canvas>
        </div>

        <div style="margin-top:15px;">
            <button class="btn-on" onclick="setSystem(true)">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn-off" onclick="setSystem(false)">‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <h3>üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Realtime)</h3>
        <div style="max-height: 200px; overflow-y: auto;">
            <table id="logTable">
                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</th></tr></thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ========================================================
        // üëá ‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° / ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
        const DB_URL = "https://viewvi-3e5ef-default-rtdb.firebaseio.com/";
        // ========================================================

        let chart;
        let lastLoggedTime = ""; // ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü Chart.js
        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)', 
                        data: [], 
                        borderColor: '#00d2ff',
                        backgroundColor: 'rgba(0, 210, 255, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, suggestedMax: 50 } },
                    plugins: { legend: { display: false } },
                    animation: false // ‡∏õ‡∏¥‡∏î Animation ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å Browser (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('th-TH'); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function fetchData() {
            try {
                let res = await fetch(DB_URL + ".json");
                let data = await res.json();

                if (data) {
                    updateUI(data);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function updateUI(data) {
            // 1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
            if (data.systemOn) {
                document.body.className = "bg-on";
                document.getElementById("status").innerText = "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
                document.getElementById("status").style.color = "#2ecc71";
            } else {
                document.body.className = "bg-off";
                document.getElementById("status").innerText = "üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î";
                document.getElementById("status").style.color = "#e74c3c";
                return; // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
            }

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            let temp = parseFloat(data.temperature || 0);
            document.getElementById("tempText").innerText = temp.toFixed(1) + " ¬∞C";

            // 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≠‡∏î‡∏õ‡∏£‡∏≠‡∏ó
            let fill = document.getElementById("tubeFill");
            let h = Math.min((temp / 50) * 100, 100);
            fill.style.height = h + "%";

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏´‡∏•‡∏≠‡∏î
            if (temp < 30) fill.style.background = "linear-gradient(to top, #2ecc71, #27ae60)";
            else if (temp < 35) fill.style.background = "linear-gradient(to top, #f39c12, #e67e22)";
            else fill.style.background = "linear-gradient(to top, #e74c3c, #c0392b)";

            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ó‡∏ô)
            // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πà‡∏á‡∏ï‡∏•‡∏≠‡∏î
            let nowTime = getCurrentTime();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            if(chart.data.labels.length > 10) { // ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 10 ‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(nowTime);
            chart.data.datasets[0].data.push(temp);
            chart.update();

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
            if (nowTime !== lastLoggedTime) {
                lastLoggedTime = nowTime;
                let logBody = document.getElementById("logBody");
                let row = `<tr><td>${nowTime}</td><td>${temp.toFixed(1)} ¬∞C</td></tr>`;
                logBody.insertAdjacentHTML('afterbegin', row);
                // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                if(logBody.children.length > 20) logBody.lastChild.remove();
            }
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô
        async function setSystem(isOn) {
            await fetch(DB_URL + "systemOn.json", {
                method: "PUT", body: JSON.stringify(isOn)
            });
            fetchData();
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        initChart();
        setInterval(fetchData, 3000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        fetchData();
    </script>
</body>
</html>
